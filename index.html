<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CodeMon 3D: Syntax Version</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Courier New', monospace; }

        #flash-overlay {
            position: fixed; inset: 0; background: white;
            opacity: 0; pointer-events: none; z-index: 100;
        }

        #battle-layer {
            position: fixed; inset: 0; display: none;
            flex-direction: column; z-index: 30;
            opacity: 0; transition: opacity 0.4s ease;
        }
        #battle-layer.visible { opacity: 1; }

        #battle-top {
            flex: 1; display: flex; align-items: flex-end;
            justify-content: space-between; padding: 24px 40px 16px;
            background: linear-gradient(180deg, #c8eaff 0%, #a8d8ff 100%);
            position: relative; overflow: hidden;
        }
        #battle-top::after {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(transparent, transparent 3px, rgba(0,0,0,0.03) 3px, rgba(0,0,0,0.03) 4px);
            pointer-events: none;
        }

        .hp-card {
            background: #1a1a2e; border: 3px solid #e94560;
            border-radius: 12px; padding: 10px 16px; min-width: 220px;
            box-shadow: 0 0 20px rgba(233,69,96,0.4), inset 0 0 10px rgba(0,0,0,0.3); z-index: 2;
        }
        .hp-card .mon-name {
            font-size: 14px; letter-spacing: 3px; color: #e94560;
            text-transform: uppercase; margin-bottom: 4px; text-shadow: 0 0 8px #e94560;
        }
        .hp-card .lv { font-size: 11px; color: #aaa; margin-bottom: 8px; }
        .hp-bar-wrap { height: 12px; background: #0d0d1a; border-radius: 6px; border: 2px solid #333; overflow: hidden; }
        .hp-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease; position: relative; overflow: hidden; }
        .hp-bar::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { to { left: 200%; } }
        .hp-bar.green  { background: linear-gradient(90deg, #00ff88, #00cc66); }
        .hp-bar.yellow { background: linear-gradient(90deg, #ffdd00, #ff9900); }
        .hp-bar.red    { background: linear-gradient(90deg, #ff2244, #ff6600); }
        .hp-nums { font-size: 12px; color: #ccc; margin-top: 5px; text-align: right; }
        .status-badge { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 4px; letter-spacing: 1px; }
        .status-bug { background: #6a0dad; color: #e0aaff; border: 1px solid #9d4edd; }
        .status-ok  { background: #004d26; color: #69ff99; border: 1px solid #00cc66; }
        .xp-bar-wrap { height: 5px; background: #0d0d1a; border-radius: 3px; margin-top: 6px; border: 1px solid #222; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, #4488ff, #88ccff); border-radius: 3px; transition: width 0.6s ease; }
        .type-bug { color: #a8d8a8; }
        .type-fire { color: #ffaa44; }
        #enemy-card { align-self: flex-start; }
        #player-card { align-self: flex-end; }

        #battle-ground {
            height: 60px;
            background: linear-gradient(180deg, #7ec850 0%, #4a9e20 60%, #3a7e10 100%);
            border-top: 3px solid #2d6010; position: relative; overflow: hidden;
        }
        #battle-ground::before {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 20px;
            background: repeating-linear-gradient(90deg, transparent, transparent 18px, rgba(0,0,0,0.08) 18px, rgba(0,0,0,0.08) 20px);
        }

        #battle-bottom { height: 160px; background: #1a1a2e; border-top: 4px solid #e94560; display: flex; position: relative; }
        #battle-msg-box { flex: 1; padding: 16px 20px; border-right: 3px solid #2d2d4e; display: flex; flex-direction: column; justify-content: space-between; }
        #battle-msg { font-size: 16px; color: #e0e0ff; line-height: 1.5; min-height: 60px; }
        .msg-cursor { display: inline-block; width: 8px; height: 16px; background: #e94560; animation: blink 0.7s infinite; vertical-align: bottom; }
        @keyframes blink { 50% { opacity: 0; } }
        #battle-mode-label { font-size: 10px; color: #e94560; letter-spacing: 3px; opacity: 0.7; }

        #cmd-grid { width: 260px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px 16px; align-content: center; }
        .cmd-btn {
            background: #0d0d1a; border: 2px solid #e94560; color: #e0e0ff;
            font-family: 'Courier New', monospace; font-size: 13px; font-weight: bold;
            letter-spacing: 1px; padding: 10px 6px; border-radius: 8px; cursor: pointer;
            text-align: center; transition: all 0.1s ease; text-transform: uppercase;
            overflow: hidden; box-shadow: 0 0 8px rgba(233,69,96,0.2);
        }
        .cmd-btn:hover:not(:disabled) { background: #e94560; color: #fff; box-shadow: 0 0 18px rgba(233,69,96,0.7); transform: scale(1.03); }
        .cmd-btn:active:not(:disabled) { transform: scale(0.97); }
        .cmd-btn:disabled { opacity: 0.35; cursor: not-allowed; border-color: #555; }
        .cmd-btn .btn-type { display: block; font-size: 9px; color: #888; margin-top: 2px; font-weight: normal; }
        .cmd-btn:hover:not(:disabled) .btn-type { color: rgba(255,255,255,0.7); }
        #btn-run { border-color: #ff6600; color: #ff9944; }
        #btn-run:hover:not(:disabled) { background: #ff6600; box-shadow: 0 0 18px rgba(255,102,0,0.7); }
        #btn-heal { border-color: #00cc88; color: #66ffcc; }
        #btn-heal:hover:not(:disabled) { background: #00aa66; box-shadow: 0 0 18px rgba(0,204,136,0.7); }
        #bottom-logo { position: absolute; right: 12px; bottom: 8px; font-size: 9px; color: #333; letter-spacing: 2px; }

        #ui-layer {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; height: 140px;
            background: #f0f0f0; border: 6px solid #444; border-radius: 15px;
            display: flex; flex-direction: column;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4); z-index: 10; transition: opacity 0.3s ease;
        }
        #text-box { flex: 1; padding: 15px; font-size: 18px; color: #222; font-weight: bold; background: #fff; border-bottom: 3px solid #ddd; border-radius: 10px 10px 0 0; line-height: 1.4; }
        #ui-status { height: 35px; background: #444; color: #0f0; font-size: 12px; line-height: 35px; text-align: center; letter-spacing: 1px; border-radius: 0 0 10px 10px; }
        .cursor { display: inline-block; width: 10px; height: 18px; background: #0f0; animation: blink 0.8s infinite; vertical-align: bottom; }

        @keyframes screenShake {
            0%,100% { transform: translate(0,0) rotate(0deg); }
            10% { transform: translate(-8px, 4px) rotate(-1deg); }
            20% { transform: translate(8px,-4px) rotate(1deg); }
            30% { transform: translate(-6px, 6px) rotate(-0.5deg); }
            40% { transform: translate(6px,-2px) rotate(0.5deg); }
            50% { transform: translate(-4px, 4px) rotate(-0.5deg); }
            60% { transform: translate(4px,-4px) rotate(0deg); }
            70% { transform: translate(-2px, 2px) rotate(0deg); }
        }
        .shaking { animation: screenShake 0.4s ease; }

        #result-banner { display: none; position: fixed; inset: 0; z-index: 200; align-items: center; justify-content: center; background: rgba(0,0,0,0.78); flex-direction: column; }
        #result-banner.show { display: flex; }
        #result-title { font-size: 52px; font-weight: bold; letter-spacing: 6px; text-transform: uppercase; margin-bottom: 16px; text-shadow: 0 0 40px currentColor; }
        #result-sub { font-size: 16px; letter-spacing: 3px; color: #aaa; }
    </style>
</head>
<body>

<div id="flash-overlay"></div>

<div id="ui-layer">
    <div id="text-box">WELCOME TO SOURCE_CODE_VILLAGE... <span class="cursor"></span></div>
    <div id="ui-status">HP: 100/100 | LVL: 5 | MODE: OVERWORLD</div>
</div>

<div id="battle-layer">
    <div id="battle-top">
        <div class="hp-card" id="enemy-card">
            <div class="mon-name" id="enemy-name">BUG.exe</div>
            <div class="lv">Lv.7 &nbsp;|&nbsp; <span class="type-bug">‚ñ† BUG</span></div>
            <div class="hp-bar-wrap"><div class="hp-bar green" id="enemy-hp-bar" style="width:100%"></div></div>
            <div class="hp-nums"><span id="enemy-hp-cur">80</span> / <span id="enemy-hp-max">80</span></div>
            <span class="status-badge status-bug">CORRUPTED</span>
        </div>
        <div class="hp-card" id="player-card">
            <div class="mon-name">CODER.exe</div>
            <div class="lv">Lv.5 &nbsp;|&nbsp; <span class="type-fire">‚ñ† HUMAN</span></div>
            <div class="hp-bar-wrap"><div class="hp-bar green" id="player-hp-bar" style="width:100%"></div></div>
            <div class="hp-nums"><span id="player-hp-cur">100</span> / <span id="player-hp-max">100</span></div>
            <div class="xp-bar-wrap"><div class="xp-bar" id="xp-bar" style="width:42%"></div></div>
            <span class="status-badge status-ok">ONLINE</span>
        </div>
    </div>
    <div id="battle-ground"></div>
    <div id="battle-bottom">
        <div id="battle-msg-box">
            <div id="battle-msg">A wild <b>BUG.exe</b> appeared!<span class="msg-cursor"></span></div>
            <div id="battle-mode-label">‚ñ∂ BATTLE MODE</div>
        </div>
        <div id="cmd-grid">
            <button class="cmd-btn" id="btn-debug" onclick="playerAttack()">[DEBUG]<span class="btn-type">ATK ¬∑ PWR 40</span></button>
            <button class="cmd-btn" id="btn-heal"  onclick="playerHeal()">[REFACTOR]<span class="btn-type">HEAL ¬∑ +25 HP</span></button>
            <button class="cmd-btn" id="btn-docs"  onclick="playerDocs()">[DOCS]<span class="btn-type">STATUS ¬∑ INFO</span></button>
            <button class="cmd-btn" id="btn-run"   onclick="playerRun()">[ALT+F4]<span class="btn-type">RUN ¬∑ ESCAPE</span></button>
        </div>
        <div id="bottom-logo">CODEMON 3D v1.0</div>
    </div>
</div>

<div id="result-banner">
    <div id="result-title">VICTORY!</div>
    <div id="result-sub">Returning to OVERWORLD...</div>
</div>

<script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>

<script type="module">
import * as THREE from 'three';

// ‚îÄ‚îÄ ENGINE ‚îÄ‚îÄ
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
scene.fog = new THREE.Fog(0x87CEEB, 15, 55);
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

// ‚îÄ‚îÄ LIGHTING ‚îÄ‚îÄ
scene.add(new THREE.AmbientLight(0xffffff, 0.8));
const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
dirLight.position.set(10, 20, 10);
dirLight.castShadow = true;
dirLight.shadow.mapSize.set(2048, 2048);
scene.add(dirLight);
const bugLight = new THREE.PointLight(0x9933ff, 0, 10);
scene.add(bugLight);

// ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ
const playerGroup = new THREE.Group();
const mat = c => new THREE.MeshStandardMaterial({ color: c });

const body = new THREE.Mesh(new THREE.BoxGeometry(0.9, 1.4, 0.7), mat(0xff4444));
body.position.y = 0.7; body.castShadow = true; playerGroup.add(body);

const head = new THREE.Mesh(new THREE.BoxGeometry(0.75, 0.75, 0.75), mat(0xffcc99));
head.position.y = 1.75; head.castShadow = true; playerGroup.add(head);

const eyes = new THREE.Mesh(new THREE.BoxGeometry(0.55, 0.18, 0.15), mat(0x111111));
eyes.position.set(0, 1.8, 0.4); playerGroup.add(eyes);

[-0.6, 0.6].forEach(x => {
    const arm = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.9, 0.25), mat(0xff4444));
    arm.position.set(x, 0.6, 0); playerGroup.add(arm);
});
[-0.25, 0.25].forEach(x => {
    const leg = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.7, 0.3), mat(0x224488));
    leg.position.set(x, -0.35, 0); playerGroup.add(leg);
});
scene.add(playerGroup);

// ‚îÄ‚îÄ BUG MONSTER ‚îÄ‚îÄ
const bugGroup = new THREE.Group();
const bugCoreMat = new THREE.MeshStandardMaterial({
    color: 0x8800cc, emissive: 0x440066, emissiveIntensity: 0.8, metalness: 0.3, roughness: 0.2
});
const bugCore = new THREE.Mesh(new THREE.IcosahedronGeometry(0.9, 1), bugCoreMat);
bugGroup.add(bugCore);

const shards = [];
const shardMat = new THREE.MeshStandardMaterial({ color: 0xff00ff, emissive: 0x880088, emissiveIntensity: 1, metalness: 0.8, roughness: 0.1 });
for (let i = 0; i < 6; i++) {
    const s = new THREE.Mesh(new THREE.BoxGeometry(0.22, 0.22, 0.22), shardMat.clone());
    s.userData = { orbitAngle: (i/6)*Math.PI*2, orbitRadius: 1.5+(i%2)*0.3, orbitSpeed: 0.8+i*0.15, orbitHeight: Math.sin(i)*0.4 };
    shards.push(s); bugGroup.add(s);
}
const errMat = new THREE.MeshStandardMaterial({ color: 0xff3333, emissive: 0xff1111, emissiveIntensity: 0.9 });
for (let i = 0; i < 4; i++) {
    const e = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.08, 0.08), errMat);
    e.userData = { orbitAngle: (i/4)*Math.PI*2+0.5, orbitRadius: 1.2, orbitSpeed: -0.5, orbitHeight: -0.3+i*0.2 };
    shards.push(e); bugGroup.add(e);
}
const glow = new THREE.Mesh(
    new THREE.PlaneGeometry(3.5, 3.5),
    new THREE.MeshBasicMaterial({ color: 0xaa00ff, transparent: true, opacity: 0.18, side: THREE.DoubleSide, blending: THREE.AdditiveBlending, depthWrite: false })
);
glow.rotation.x = -Math.PI/2; glow.position.y = -0.85;
bugGroup.add(glow);
bugGroup.position.set(3, 1.5, -4);
bugGroup.visible = false;
scene.add(bugGroup);

// ‚îÄ‚îÄ WORLD ‚îÄ‚îÄ
const TILE_SIZE = 2;
window.grassTiles = []; window.solidObjects = [];

function buildWorld() {
    const wg = new THREE.Group();
    for (let x = -10; x <= 10; x++) {
        for (let z = -10; z <= 10; z++) {
            const isGrass = Math.random() > 0.82 && (Math.abs(x)>2||Math.abs(z)>2);
            const isPath = (x >= -2 && x <= 2 && z >= -6 && z <= -2); // Define the path area
            const tile = new THREE.Mesh(new THREE.BoxGeometry(1.9,0.2,1.9), new THREE.MeshStandardMaterial({ color: isPath ? 0x777777 : isGrass ? 0x55cc55 : 0x77dd77 }));
            tile.position.set(x*TILE_SIZE,-0.1,z*TILE_SIZE); tile.receiveShadow=true; wg.add(tile);
            if (isGrass) {
                const bl = new THREE.Mesh(new THREE.BoxGeometry(1.6,0.4,1.6), new THREE.MeshStandardMaterial({ color: 0x228822 }));
                bl.position.set(x*TILE_SIZE,0.2,z*TILE_SIZE); wg.add(bl);
                window.grassTiles.push(bl);
            }
            if (Math.abs(x)===10||Math.abs(z)===10) createTree(x*TILE_SIZE,z*TILE_SIZE,wg);
        }
    }
    const lab = new THREE.Mesh(new THREE.BoxGeometry(4,3,4), new THREE.MeshStandardMaterial({ color: 0xffffff }));
    lab.position.set(0,1.5,-6); lab.castShadow=true; wg.add(lab); window.solidObjects.push(lab);
    [[-.8,2,-.8],[.8,2,-.8]].forEach(([wx,wy,wz]) => {
        const w = new THREE.Mesh(new THREE.BoxGeometry(0.7,0.7,0.1), new THREE.MeshStandardMaterial({ color: 0x88ccff, emissive: 0x4488aa, emissiveIntensity: 0.4 }));
        w.position.set(wx,wy,wz-6); wg.add(w);
    });
    const roof = new THREE.Mesh(new THREE.ConeGeometry(3.5,2,4), new THREE.MeshStandardMaterial({ color: 0xcc3333 }));
    roof.position.set(0,4,-6); roof.rotation.y=Math.PI/4; wg.add(roof);
    const sign = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.8,0.1), new THREE.MeshStandardMaterial({ color: 0xddbb77 }));
    sign.position.set(1.5,0.8,-3.5); wg.add(sign); window.solidObjects.push(sign);
    scene.add(wg);
}
function createTree(x,z,group) {
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.35,1.2), new THREE.MeshStandardMaterial({ color: 0x663300 }));
    trunk.position.set(x,0.6,z); trunk.castShadow=true; group.add(trunk);
    const leaves = new THREE.Mesh(new THREE.SphereGeometry(1,8,8), new THREE.MeshStandardMaterial({ color: 0x22aa22 }));
    leaves.position.set(x,2.0,z); leaves.castShadow=true; group.add(leaves);
    window.solidObjects.push(trunk);
}
buildWorld();

// Add NPC
const npcGroup = new THREE.Group();
const npcBody = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.5, 0.7), mat(0x4444ff));
npcBody.position.y = 0.75;
npcBody.castShadow = true;
npcGroup.add(npcBody);

const npcHead = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), mat(0x9999ff));
npcHead.position.y = 1.7;
npcHead.castShadow = true;
npcGroup.add(npcHead);

npcGroup.position.set(-2, 0, -4); // Position near the Lab
scene.add(npcGroup);
window.solidObjects.push(npcGroup);

// Add particle system for digital rain
const particleCount = 500;
const particles = new THREE.BufferGeometry();
const positions = new Float32Array(particleCount * 3);
const colors = new Float32Array(particleCount * 3);
const sizes = new Float32Array(particleCount);

const color = new THREE.Color();
for (let i = 0; i < particleCount; i++) {
    positions[i * 3] = (Math.random() - 0.5) * 100;
    positions[i * 3 + 1] = Math.random() * 100 + 20;
    positions[i * 3 + 2] = (Math.random() - 0.5) * 100;
    color.setHSL(Math.random() * 0.1 + 0.6, 0.8, 0.5);
    colors[i * 3] = color.r;
    colors[i * 3 + 1] = color.g;
    colors[i * 3 + 2] = color.b;
    sizes[i] = Math.random() * 0.5 + 0.5;
}

particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));
particles.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

const particleMaterial = new THREE.PointsMaterial({
    size: 0.1,
    vertexColors: true,
    transparent: true,
    opacity: 0.8
});

const particleSystem = new THREE.Points(particles, particleMaterial);
scene.add(particleSystem);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let gameState='OVERWORLD', isMoving=false, playerTurn=true, battleLocked=false;
let playerHP=100, playerMaxHP=100, enemyHP=80, enemyMaxHP=80, healCharges=2;
const targetPos = new THREE.Vector3();
const battleCamPos  = new THREE.Vector3(-1, 2.8, 2.5);
const battleCamLook = new THREE.Vector3(2.5, 1.2, -3.5);

// Define the properties for different enemies
const enemies = [
    {
        name: "BUG.exe",
        hp: 80,
        attackMessages: [
            "BUG.exe threw a <b>SyntaxError</b>!",
            "BUG.exe caused a <b>SegFault</b>! Memory corrupted!",
            "BUG.exe injected <b>undefined behaviour</b>!",
            "BUG.exe panicked: <b>index out of bounds</b>!",
            "BUG.exe is leaking memory. HP <b>slowly draining</b>!"
        ]
    },
    {
        name: "GLITCH.js",
        hp: 90,
        attackMessages: [
            "GLITCH.js caused a <b>TypeError</b>!",
            "GLITCH.js is glitching out!",
            "GLITCH.js corrupted your data!",
            "GLITCH.js is unstable!"
        ]
    },
    {
        name: "MALWARE.msi",
        hp: 100,
        attackMessages: [
            "MALWARE.msi is spreading!",
            "MALWARE.msi corrupted your files!",
            "MALWARE.msi is infecting your system!",
            "MALWARE.msi is causing havoc!"
        ]
    }
];

// Add a variable to track if the player is near the NPC
let nearNPC = false;

// Initialize audio context
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// Function to create a beep sound
function playBeep() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.type = 'square';
    oscillator.frequency.value = 440;
    gainNode.gain.value = 0.1;
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1);
    oscillator.stop(audioContext.currentTime + 0.1);
}

// Function to create a crash sound
function playCrash() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.type = 'sawtooth';
    oscillator.frequency.value = 220;
    gainNode.gain.value = 0.2;
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.2);
    oscillator.stop(audioContext.currentTime + 0.2);
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ
addEventListener('keydown', e => {
    if (isMoving||gameState!=='OVERWORLD') return;
    const k=e.key.toLowerCase();
    let nx=playerGroup.position.x, nz=playerGroup.position.z;
    if(k==='w'||e.key==='ArrowUp')    {nz-=TILE_SIZE; playerGroup.rotation.y=Math.PI;}
    if(k==='s'||e.key==='ArrowDown')  {nz+=TILE_SIZE; playerGroup.rotation.y=0;}
    if(k==='a'||e.key==='ArrowLeft')  {nx-=TILE_SIZE; playerGroup.rotation.y=-Math.PI/2;}
    if(k==='d'||e.key==='ArrowRight') {nx+=TILE_SIZE; playerGroup.rotation.y= Math.PI/2;}
    const hit=window.solidObjects.some(o=>Math.abs(o.position.x-nx)<1.1&&Math.abs(o.position.z-nz)<1.1);
    if(!hit&&(nx!==playerGroup.position.x||nz!==playerGroup.position.z)){targetPos.set(nx,0,nz);isMoving=true; playBeep();}
    if (e.code === 'Space' && nearNPC) {
        setOWText("It's dangerous to debug alone! Take this REFACTOR.exe!");
    }
});

// ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ
const clock = new THREE.Clock();
(function animate(){
    requestAnimationFrame(animate);
    const t = clock.getElapsedTime();
    playerGroup.position.y = Math.sin(t*3)*0.04;

    // Update particle positions
    const positions = particleSystem.geometry.attributes.position.array;
    for (let i = 0; i < particleCount; i++) {
        positions[i * 3 + 1] -= 0.1; // Move particles downward
        if (positions[i * 3 + 1] < 0) {
            positions[i * 3 + 1] = 50; // Reset to top if below bottom
        }
    }
    particleSystem.geometry.attributes.position.needsUpdate = true;

    // Check if player is near the NPC
    const distanceToNPC = playerGroup.position.distanceTo(npcGroup.position);
    nearNPC = distanceToNPC < 2;

    if(gameState==='OVERWORLD'){
        if(isMoving){
            playerGroup.position.lerp(targetPos,0.15);
            if(playerGroup.position.distanceTo(targetPos)<0.05){
                playerGroup.position.copy(targetPos); playerGroup.position.y=0;
                isMoving=false; checkGrass();
            }
        }
        camera.position.lerp(new THREE.Vector3(playerGroup.position.x,10,playerGroup.position.z+12),0.1);
        camera.lookAt(playerGroup.position);
    }
    if(gameState==='BATTLE'){
        bugGroup.position.y=1.5+Math.sin(t*1.8)*0.18;
        bugCore.rotation.x=t*0.5; bugCore.rotation.y=t*0.7;
        shards.forEach(s=>{
            const d=s.userData;
            d.orbitAngle+=d.orbitSpeed*0.016;
            s.position.x=Math.cos(d.orbitAngle)*d.orbitRadius;
            s.position.z=Math.sin(d.orbitAngle)*d.orbitRadius;
            s.position.y=d.orbitHeight+Math.sin(t*2+d.orbitAngle)*0.15;
            s.rotation.x=t; s.rotation.y=t*1.3;
        });
        bugLight.intensity=1.5+Math.sin(t*3)*0.5;
        bugLight.position.copy(bugGroup.position);
        camera.position.lerp(battleCamPos,0.05);
        camera.lookAt(battleCamLook);
    }
    renderer.render(scene,camera);
})();

// ‚îÄ‚îÄ GRASS ‚îÄ‚îÄ
function checkGrass(){
    const px=playerGroup.position.x,pz=playerGroup.position.z;
    const onG=window.grassTiles.some(g=>Math.abs(g.position.x-px)<0.6&&Math.abs(g.position.z-pz)<0.6);
    if(onG&&Math.random()>0.72) startBattleTransition();
    else setOWText("Exploring the codebase... <span class='cursor'></span>");
}
function setOWText(h){document.getElementById('text-box').innerHTML=h;}

// ‚îÄ‚îÄ TRANSITION ‚îÄ‚îÄ
function startBattleTransition(){
    const fl=document.getElementById('flash-overlay');
    let n=0;
    const randomEnemy = enemies[Math.floor(Math.random() * enemies.length)];
    setOWText(`!!! Wild <b>${randomEnemy.name}</b> detected in the codebase!`);
    // Store the selected enemy in a variable accessible to other functions
    window.currentEnemy = randomEnemy;
    (function flash(){
        if(n>=7){enterBattle();return;}
        fl.style.opacity=n%2===0?'1':'0';
        n++; setTimeout(flash,n<4?80:120);
    })();
}
function enterBattle(){
    gameState='BATTLE';
    playerHP=playerMaxHP; enemyHP=window.currentEnemy.hp; enemyMaxHP=window.currentEnemy.hp; healCharges=2;
    updateHPBars(); enableButtons(true);
    playerTurn=true; battleLocked=false;
    bugGroup.visible=true; bugLight.intensity=2;
    document.getElementById('flash-overlay').style.opacity='0';
    document.getElementById('ui-layer').style.cssText+='opacity:0;pointer-events:none;';
    const bl=document.getElementById('battle-layer');
    bl.style.display='flex';
    requestAnimationFrame(()=>bl.classList.add('visible'));
    setBattleMsg(`A wild <b>${window.currentEnemy.name}</b> appeared! > Choose your action...`);
}

// ‚îÄ‚îÄ BATTLE ACTIONS ‚îÄ‚îÄ
window.playerAttack=()=>{
    if(!playerTurn||battleLocked)return;
    battleLocked=true; enableButtons(false);
    const dmg=18+Math.floor(Math.random()*18);
    enemyHP=Math.max(0,enemyHP-dmg); updateHPBars(); shakeScreen();
    bugCoreMat.emissive.set(0xff0000);
    setTimeout(()=>bugCoreMat.emissive.set(0x440066),300);
    setBattleMsg(`You used <b>[DEBUG]</b>! Injected <b>${dmg} dmg</b> into ${window.currentEnemy.name}!`);
    playCrash();
    if(enemyHP<=0){setTimeout(winBattle,900);return;}
    setTimeout(enemyTurn,1100);
};
window.playerHeal=()=>{
    if(!playerTurn||battleLocked)return;
    if(healCharges<=0){setBattleMsg("‚ö† <b>REFACTOR</b> failed ‚Äî no charges remaining!");return;}
    battleLocked=true; enableButtons(false);
    const heal=22+Math.floor(Math.random()*8);
    playerHP=Math.min(playerMaxHP,playerHP+heal); healCharges--;
    updateHPBars();
    setBattleMsg(`You used <b>[REFACTOR]</b>! Restored <b>${heal} HP</b>. (${healCharges} charge${healCharges!==1?'s':''} left)`);
    setTimeout(enemyTurn,1100);
};
window.playerDocs=()=>{
    if(!playerTurn||battleLocked)return;
    battleLocked=true; enableButtons(false);
    const msgs=[
        "üìÑ <b>[DOCS]</b> ‚Ä∫ BUG.exe: corrupted runtime entity. Weakness: type assertions.",
        "üìÑ <b>[DOCS]</b> ‚Ä∫ Stack trace: <i>NullPointerException at line ‚àû</i>",
        "üìÑ <b>[DOCS]</b> ‚Ä∫ ERROR 404: documentation not found. Classic.",
        "üìÑ <b>[DOCS]</b> ‚Ä∫ BUG.exe has been in prod for 3 years. Nobody dares touch it.",
    ];
    setBattleMsg(msgs[Math.floor(Math.random()*msgs.length)]);
    setTimeout(enemyTurn,1300);
};
window.playerRun=()=>{
    if(!playerTurn||battleLocked)return;
    battleLocked=true; enableButtons(false);
    if(Math.random()>0.45){
        setBattleMsg("üèÉ You pressed <b>ALT+F4</b>... but the process is unresponsive!");
        setTimeout(enemyTurn,1200);
    } else {
        setBattleMsg("üèÉ <b>ALT+F4</b> executed! Process terminated. You escaped!");
        setTimeout(exitBattle,1400);
    }
};

function enemyTurn(){
    playerTurn=false;
    const atk = window.currentEnemy.attackMessages[Math.floor(Math.random() * window.currentEnemy.attackMessages.length)];
    const dmg=10+Math.floor(Math.random()*10);
    playerHP=Math.max(0,playerHP-dmg); updateHPBars(); shakeScreen();
    setBattleMsg(`${atk} You took <b>${dmg} dmg</b>!`);
    if(playerHP<=0){setTimeout(loseBattle,1000);return;}
    setTimeout(()=>{
        playerTurn=true; battleLocked=false; enableButtons(true);
        setBattleMsg("What will you do? > Choose your action...");
    },1300);
}

function winBattle(){
    enableButtons(false);
    setBattleMsg(`‚úÖ <b>${window.currentEnemy.name}</b> was squashed! <b>120 XP</b> gained!`);
    document.getElementById('xp-bar').style.width='78%';
    showBanner('#00ff88','VICTORY!','BUG.exe squashed  |  Returning to OVERWORLD...');
    setTimeout(exitBattle,2600);
}
function loseBattle(){
    enableButtons(false);
    setBattleMsg("üíÄ <b>SYSTEM CRASH!</b> You have been deleted.");
    playerHP=playerMaxHP;
    showBanner('#ff2244','GAME OVER','Rebooting from last save...');
    setTimeout(exitBattle,2800);
}
function showBanner(color,title,sub){
    const b=document.getElementById('result-banner');
    b.querySelector('#result-title').style.color=color;
    b.querySelector('#result-title').textContent=title;
    b.querySelector('#result-sub').textContent=sub;
    b.classList.add('show');
}
function exitBattle(){
    document.getElementById('result-banner').classList.remove('show');
    const bl=document.getElementById('battle-layer');
    bl.classList.remove('visible');
    setTimeout(()=>{
        bl.style.display='none';
        bugGroup.visible=false; bugLight.intensity=0;
        gameState='OVERWORLD';
        const ul=document.getElementById('ui-layer');
        ul.style.opacity='1'; ul.style.pointerEvents='auto';
        camera.position.set(playerGroup.position.x,10,playerGroup.position.z+12);
        setOWText("Back in the OVERWORLD. The bugs are restless... <span class='cursor'></span>");
        document.getElementById('ui-status').textContent=`HP: ${playerHP}/${playerMaxHP} | LVL: 5 | MODE: OVERWORLD`;
    },500);
}

function setBattleMsg(h){document.getElementById('battle-msg').innerHTML=h+'<span class="msg-cursor"></span>';}
function updateHPBars(){
    const ep=(enemyHP/enemyMaxHP)*100, pp=(playerHP/playerMaxHP)*100;
    const eb=document.getElementById('enemy-hp-bar');
    eb.style.width=ep+'%'; eb.className='hp-bar '+(ep>50?'green':ep>25?'yellow':'red');
    document.getElementById('enemy-hp-cur').textContent=enemyHP;
    const pb=document.getElementById('player-hp-bar');
    pb.style.width=pp+'%'; pb.className='hp-bar '+(pp>50?'green':pp>25?'yellow':'red');
    document.getElementById('player-hp-cur').textContent=playerHP;
}
function enableButtons(on){
    ['btn-debug','btn-heal','btn-docs','btn-run'].forEach(id=>document.getElementById(id).disabled=!on);
}
function shakeScreen(){
    const el=document.getElementById('battle-layer');
    el.classList.remove('shaking'); void el.offsetWidth; el.classList.add('shaking');
    setTimeout(()=>el.classList.remove('shaking'),450);
}

addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
